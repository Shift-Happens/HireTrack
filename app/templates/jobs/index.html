{% extends "base.html" %}
{% block title %}My Jobs{% endblock %}
{% block content %}
<div class="header-row">
    <h1 class="page-title">My Job Applications:</h1>
    <div class="actions-box">
        <a href="{{ url_for('jobs.export_jobs') }}" class="btn-action">
            <i class="fas fa-download"></i> Export CSV
        </a>
        <input type="file" name="file" accept=".csv" id="import-file" class="hidden">
        <label for="import-file" class="btn-action">
            <i class="fas fa-upload"></i> Import CSV
        </label>
    </div>
</div>

{% if is_new_user %}
<div class="welcome-card">
    <h2>Welcome to HireTrack!</h2>
    <p>Get started by clicking the "Add Job" button to track your first job application.</p>
    <a href="{{ url_for('jobs.new_job') }}" class="btn-primary">Add Your First Job</a>
</div>
{% else %}

<table>
    <tr>
        <th>Company</th>
        <th>Position</th>
        <th>Contract</th>
        <th>Location</th>
        <th>Work Type</th>
        <th>Salary Range</th>
        <th>Applied Date</th>
        <th>Links</th>
        <th>Notes</th>
        <th>Status</th>
        <th>Actions</th>
    </tr>
    {% for job in jobs %}
    <tr>
        <td>{{ job.company }}</td>
        <td>{{ job.position }}</td>
        <td class="contract-cell" title="{{ job.contract_type }}">
            {{ job.contract_type[:20] + '...' if job.contract_type|length > 20 else job.contract_type }}
        </td>
        <td class="location-cell" title="{{ job.location }}">{{ job.location }}</td>
        <td><span class="work-type work-type-{{ job.work_type.lower() }}">{{ job.work_type }}</span></td>
        <td>
            {% if job.salary_min or job.salary_max %}
                {% set symbols = {
                    'USD': '$',
                    'EUR': '€',
                    'GBP': '£',
                    'PLN': 'zł',
                    'CAD': 'C$',
                    'AUD': 'A$'
                } %}
                {{ symbols[job.salary_currency] }}{{ job.salary_min or '?' }} - {{ symbols[job.salary_currency] }}{{ job.salary_max or '?' }}
            {% endif %}
        </td>
        <td>{{ job.applied_date.strftime('%d-%m-%y') }}</td>
        <td>
            {% if job.job_link %}
                <a href="{{ job.job_link }}" target="_blank" class="view-job">View Job</a>
            {% endif %}
        </td>
        <td class="notes-cell" title="{{ job.notes or '' }}">
            {{ job.notes[:50] + '...' if job.notes and job.notes|length > 50 else job.notes or '' }}
        </td>
        <td>
            <select class="status-select status-{{ job.status.lower() }}" data-job-id="{{ job.id }}">
                <option value="Applied" {% if job.status == 'Applied' %}selected{% endif %}>Applied</option>
                <option value="Interview" {% if job.status == 'Interview' %}selected{% endif %}>Interview</option>
                <option value="Offered" {% if job.status == 'Offered' %}selected{% endif %}>Offered</option>
                <option value="Rejected" {% if job.status == 'Rejected' %}selected{% endif %}>Rejected</option>
            </select>
        </td>
        <td>
            <a href="{{ url_for('jobs.edit_job', id=job.id) }}" class="btn-edit">Edit</a>
        </td>
    </tr>
    {% endfor %}
</table>
{% endif %}

<script>
document.querySelectorAll('.status-select').forEach(select => {
    select.addEventListener('change', async (e) => {
        const jobId = e.target.dataset.jobId;
        const newStatus = e.target.value;
        
        try {
            const response = await fetch(`/job/${jobId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            });
            
            if (response.ok) {
                // Update the select element's classes
                e.target.className = `status-select status-${newStatus.toLowerCase()}`;
            }
        } catch (error) {
            console.error('Error updating status:', error);
        }
    });
});

document.getElementById('import-file').addEventListener('change', async function(e) {
    if (this.files.length > 0) {
        const formData = new FormData();
        formData.append('file', this.files[0]);

        try {
            const response = await fetch("{{ url_for('jobs.import_jobs') }}", {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                window.location.reload();
            } else {
                console.error('Import failed');
            }
        } catch (error) {
            console.error('Error importing file:', error);
        }
    }
});
</script>
{% endblock %}